# --- 공통 DNS 재해석 (Docker 내부 DNS)
resolver 127.0.0.11 valid=30s;
resolver_timeout 5s;

# --- 백엔드 업스트림 풀: Docker 컨테이너 IP가 바뀌어도 자동 재해석
upstream backend_pool {
  zone backend_pool 64k;
  server backend:8083 resolve;
  keepalive 64;                 # 커넥션 재사용
}

# --- 더 좋은 장애 분석을 위한 로그 포맷 (http 레벨로 이동)
log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" "$http_user_agent" '
                'rt=$request_time urt=$upstream_response_time ustat=$upstream_status';

# --- 80 → 443 리다이렉트 + ACME 챌린지
server {
    listen 80;
    server_name seosan-issue.shop;

    access_log /var/log/nginx/access.log main; # access_log는 여기에 유지해도 좋습니다.

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# --- HTTPS 본 서버
server {
    listen 443 ssl http2;
    server_name seosan-issue.shop;

    access_log /var/log/nginx/access.log main;

    ssl_certificate     /etc/letsencrypt/live/seosan-issue.shop/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/seosan-issue.shop/privkey.pem;

    # ... (이하 나머지 location 블록 설정들은 그대로 유지) ...
    # location = / { ... }
    # location ~ /\.(git|env|hg|svn|DS_Store) { ... }
    # location / { ... }
    # ... 등등
}