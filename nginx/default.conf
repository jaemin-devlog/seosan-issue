server {
  listen 80;
  server_name seosan-issue.shop;

  location /.well-known/acme-challenge/ { root /var/www/certbot; }
  location / { return 301 https://$host$request_uri; }
}

server {
  listen 443 ssl;
  server_name seosan-issue.shop;

  ssl_certificate     /etc/letsencrypt/live/seosan-issue.shop/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/seosan-issue.shop/privkey.pem;

  # 루트는 Nginx가 바로 응답 → 봇/헬스체크로 인한 500 차단
  location = / {
    return 200 "ok\n";
    add_header Content-Type text/plain;
  }

  # 긴 처리(요약 API)는 connect 대기 늘림
  location = /api/v1/ai-search {
    proxy_pass http://backend:8083;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_connect_timeout  90s;   # ★ 연결 대기 여유
    proxy_send_timeout     330s;
    proxy_read_timeout     330s;
    send_timeout           330s;
  }

  # 그 외 일반 요청
  location / {
    proxy_pass http://backend:8083;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_connect_timeout  30s;
    proxy_send_timeout     310s;
    proxy_read_timeout     310s;
    send_timeout           310s;
  }
}
